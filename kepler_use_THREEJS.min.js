var KEPLER={VERSION:"0.0.7",UNIT_LENGTH:"meter"};KEPLER.MAX_SAFE_LENGTH=Number.MAX_SAFE_INTEGER;KEPLER.KILOMETER=KEPLER.KM=1E3;KEPLER.AU=1496E8;KEPLER.LIGHT_SECOND=2998E5;KEPLER.LIGHT_MINUTE=1799E7;KEPLER.LIGHT_HOUR=1079E9;KEPLER.LIGHT_DAY=259E11;KEPLER.LIGHT_YEAR=9461E12;KEPLER.UNIT_TIME="second";KEPLER.MAX_SAFE_TIME=Number.MAX_SAFE_INTEGER;KEPLER.MINUTE=60;KEPLER.HOUR=3600;KEPLER.DAY=86400;KEPLER.YEAR=3154E4;KEPLER.UNIT_ROTATION="Radians";KEPLER.DEGREE=.0174533;KEPLER.PI=Math.PI;
KEPLER.DEGREES_PER_DAY=KEPLER.DEGREE/KEPLER.DAY;KEPLER.UNIT_mass="Kilograms";KEPLER.TONNE=KEPLER.TON=1E3;KEPLER.EARTH_MASS=5.974E24;KEPLER.SOL_MASS=1.9891E30;KEPLER.G=6.674E-11;KEPLER.Vector3=THREE.Vector3;KEPLER.Matrix4=THREE.Matrix4;
KEPLER.AstroBody=function(c,b,a){this.id=c;this.mass=b;Object.defineProperties(this,{orbit:{enumerable:!0,value:a}});this.satellites=[];this.primary=a.primary;this.primary.addSatellite(this);this.getElements=function(){return a.getElements()};this.getPosition=function(){return a.getPosition()};this.getVelocity=function(){return a.getVelocity()};this.addTime=function(){return a.addTime()};this.subTime=function(){return a.subTime()};this.clone=function(){var a=this.getElements(),b=this.id,g=this.mass,
c=this.satellites,a=new KEPLER.Orbit(this.primary,a.a,a.ecc,a.mAnomaly,a.rotI,a.rotW,a.rotOmeg),e=new KEPLER.AstroBody(b,g,a);c.forEach(function(a){e.addSatellite(a.clone())});return e};this.addSatellite=function(a){this.satellites.push(a)};this.removeSatellite=function(a){this.satellites=this.satellites.filter(function(b){return b!==a})}};
KEPLER.Orbit=function(c,b,a,d,f,g,h){this.primary=c;var e=KEPLER.G*this.primary.mass,m=0,l=0,p=0,q=0,r=0,k=0,n=0,t=function(){if(1>a)return(1-a)*b;if(1===a)return b;if(1<a)return(1-a)*b},v=function(){if(0===a)return d;if(1>a){n=u();var b=2*Math.atan2(Math.sqrt(1+a)*Math.sin(n/2),Math.sqrt(1-a)*Math.cos(n/2));return b}if(1===a)return b=1.5*d,b=Math.cbrt(b+Math.sqrt(b*b+1)),b=2*Math.atan(b-1/b);if(1<=a)return n=u(),b=2*Math.atanh(Math.sqrt(1+a)*Math.sin(n/2)/Math.sqrt(1-a)*Math.cos(n/2))},x=function(){if(1>
a)return Math.pow(b*b*b/e,.5)*d;if(1===a)return Math.pow(2*b*b*b/e,.5)*d;if(1<a)return Math.pow(-b*-b*-b/e,.5)*d},u=function(){if(0===a)return d;if(1>a){for(var b=d,c=b,g=0;1E-10<Math.abs(c-a*Math.sin(c)-b);)if(c-=(c-a*Math.sin(c)-b)/(1-a*Math.cos(c)),g++,1E3<=g)throw"took too long to determine E for "+this.id;return c}if(1===a)return r=v(),Math.tan(r/2);if(1<a){c=b=d;for(g=0;1E-10<Math.abs(a*Math.sinh(c)-c-b);)if(c-=(a*Math.sinh(c)-c-b)/(a*Math.cosh(c)-1),g++,1E3<=g)throw"took too long to determine E for "+
this.id;return c}};this.updateElement={peri:function(){return m=t()},apo:function(){l=1>a?(1+a)*b:1<=a?Infinity:void 0;return l},T:function(){p=1>a?2*KEPLER.PI*Math.pow(b*b*b/e,.5):1<=a?Infinity:void 0;return p},meanMotion:function(){q=1>a?Math.pow(b*b*b/e,-.5):1<=a?Infinity:void 0;return q},tAnomaly:function(){return r=v()},periT:function(){return k=x()},E:function(){return n=u()}};this.updateAllElements=function(){this.updateElement.peri();this.updateElement.apo();this.updateElement.T();this.updateElement.meanMotion();
this.updateElement.tAnomaly();this.updateElement.periT();this.updateElement.E()};this.getElements=function(){this.updateAllElements();return{a:b,ecc:a,mAnomaly:d,rotI:f,rotW:g,rotOmeg:h,mu:e,peri:m,apo:l,T:p,meanMotion:q,tAnomaly:r,periT:k,E:n}};var w=function(a){var b=new KEPLER.Vector3(0,0,1),b=(new KEPLER.Matrix4).makeRotationAxis(b,-g);a.applyMatrix4(b);b=new KEPLER.Vector3(1,0,0);b=(new KEPLER.Matrix4).makeRotationAxis(b,-f);a.applyMatrix4(b);b=new KEPLER.Vector3(0,0,1);b=(new KEPLER.Matrix4).makeRotationAxis(b,
-h);a.applyMatrix4(b);return a};this.getPosition=function(){this.updateElement.E();var c=new KEPLER.Vector3(b*Math.cos(n)-b*a,b*Math.sqrt(1-a*a)*Math.sin(n),0),c=w(c);c.add(this.primary.getPosition());return c};this.getVelocity=function(){this.updateElement.E();this.updateElement.meanMotion();var c=new KEPLER.Vector3(q*b/(1-a*Math.cos(n))*-Math.sin(n),q*b/(1-a*Math.cos(n))*Math.sqrt(1-a*a)*Math.cos(n),0),c=w(c);c.add(this.primary.getVelocity());return c};this.clone=function(){this.updateAllElements();
var a=this.getElements();return new KEPLER.Orbit(this.primary,a.a,a.ecc,a.mAnomaly,a.rotI,a.rotW,a.rotOmeg)};this.addTime=function(a){this.updateElement.meanMotion();d=((d+a*q%(2*KEPLER.PI))%(2*KEPLER.PI)+2*KEPLER.PI)%(2*KEPLER.PI);this.updateAllElements();return this};this.subTime=function(a){return this.addTime(-a)};this.addVelocity=function(c){var k=this.getPosition(),m=this.getVelocity();m.add(c);var q=k.clone(),l=m.clone();c=new KEPLER.Vector3(0,0,0);c.crossVectors(k,m);var r=Math.atan(c.x/-c.y),
n=Math.atan(Math.sqrt(c.x*c.x+c.y*c.y)/c.z),p=new THREE.Vector3(0,0,0);p.copy(q);var t=new THREE.Vector3(0,0,1),r=(new THREE.Matrix4).makeRotationAxis(t,r);p.applyMatrix4(r);r=new THREE.Vector3(1,0,0);n=(new THREE.Matrix4).makeRotationAxis(r,n);p.applyMatrix4(n);q=q.length();l=l.length();c=c.length();l=e*q/(2*e-q*l*l);c=Math.sqrt(1-c*c/(e*l));k.dot(m);k={a:l,ecc:c,mAnomaly:d,rotI:f,rotW:g,rotOmeg:h};b=k.a;a=k.ecc;d=k.mAnomaly;f=k.rotI;g=k.rotW;h=k.rotOmeg;this.updateAllElements();return k}};
KEPLER.NULL_ORBIT=function(){this.primary={mass:1};KEPLER.Orbit.call(this,this.primary,0,0,0,0,0,0);this.getPosition=function(){return new KEPLER.Vector3(0,0,0)};this.getVelocity=function(){return new KEPLER.Vector3(0,0,0)};this.primary.addSatellite=function(c){};this.primary.removeSatellite=function(c){};this.updateAllElements()};KEPLER.NULL_ORBIT.prototype=Object.create(KEPLER.Orbit.prototype);
KEPLER.Spacecraft=function(c,b,a,d,f){KEPLER.AstroBody.call(this,c,b,f);this.deltaV=this.fuel=0;this.addFuel=function(b){var c=this.fuel.value;if(c+b>a)throw"Cannot add more fuel to "+this.id+", fuel Capacity Exceeded. Fuel Tank Size: "+a+" kg";if(0>c+b)throw"Cannot subtract fuel from "+this.id+", insufficient fuel";this.fuel=c+b;this.updateDeltaV();return!0};this.subFuel=function(a){this.addFuel(-a);return!0};this.subDeltaV=function(a){if(0>this.deltaV.value-a)throw"Cannot subtract deltaV from "+
this.id+", insufficient deltaV";this.subFuel((this.mass+this.fuel)*(1-1/Math.exp(a/this.exhaustVEff)));return!0};this.updateDeltaV=function(){var a=this.mass;this.deltaV=this.exhaustVEff*Math.log((a+this.fuel)/a);return!0}};KEPLER.Spacecraft.prototype=Object.create(KEPLER.AstroBody.prototype);
KEPLER.Transfer=function(c,b,a){if(c.primary!==b.primary)throw"Cannot create Transfer from Orbiting "+c.primary+" to orbiting "+b.primary;var d=KEPLER.Lambert(c,b,a);if(-1===d)return-1;c=c.clone();b=b.clone();b.addTime(a);var f=c.getVelocity(),g=b.getVelocity(),h=d.departure.clone();h.sub(f);var e=d.arrival.clone();e.sub(g);var m=h.length()+e.length();return{object1:c,object2:b,object1_v:f,object2_v:g,duration:a,vector1:d.departure,vector2:d.arrival,thrust1:h,thrust2:e,delta_v:m}};
KEPLER.Lambert=function(c,b,a){if(c.primary!==b.primary)throw"Cannot use lambert solver to find path from Orbiting "+c.primary+" to orbiting "+b.primary;var d=c.clone();b=b.clone();b.addTime(a);d=d.getPosition();b=b.getPosition();var f=d.length(),g=b.length(),h=1*Math.sqrt(f*g+d.dot(b));if(0===h)return 0;var e=0,m=.5,l=1/6,p=4*Math.PI*Math.PI,q=-4*Math.PI,r=0,k=0,n=0,t=0;for(c=c.getElements().mu;1<Math.abs(r-a);)if(k=f+g+h*(e*l-1)/Math.sqrt(m),0<h&&0>k&&(k=0),n=Math.sqrt(k/m),r=(Math.pow(n,3)*l+h*
Math.sqrt(k))/Math.sqrt(c),r<=a?q=e:p=e,e=(p+q)/2,1E-6<e?(m=(1-Math.cos(Math.sqrt(e)))/e,l=(Math.sqrt(e)-Math.sin(Math.sqrt(e)))/Math.pow(e,1.5)):-1E-6>e?(m=(1-Math.cosh(Math.sqrt(-e)))/e,l=(Math.sinh(Math.sqrt(-e))-Math.sqrt(-e))/Math.pow(-e,1.5)):(m=.5,l=1/6),t++,150<t)return-1;f=1-k/f;a=1-k/g;c=h*Math.sqrt(k/c);h=new THREE.Vector3(0,0,0);k=new THREE.Vector3(0,0,0);k.copy(d);k.multiplyScalar(f);h.subVectors(b,k).divideScalar(c);k=new THREE.Vector3(0,0,0);g=new THREE.Vector3(0,0,0);g.copy(b);g.multiplyScalar(a);
k.subVectors(g,d).divideScalar(c);return{departure:h,arrival:k}};KEPLER.TransferSolver={};KEPLER.TransferSolver.bisectionSlopeSolver=function(c,b,a,d,f){var g=0,h,e,m,l;do if(h=Math.ceil((c+b)/2),m=a(h,f),e=h+1,l=a(e,f),m=d(m,l,function(){return a(c,f)},function(){return a(b,f)}),0<m?c=h:0>m?b=h:(c=h,b=e),g++,100<g)throw"KEPLER.TransferSolver.bisectionSlopeSolver took too long to calculate using:\n"+a;while(1<b-c);return h};
KEPLER.TransferSolver.minDeltaV_LaunchSpecified=function(c,b,a){a=void 0===a?0:a;c=c.clone();b=b.clone();c.addTime(a);b.addTime(a);a=c.getElements();var d=b.getElements();a=KEPLER.TransferSolver.bisectionSlopeSolver(1,Math.max(a.T,d.T),function(a,b){return new KEPLER.Transfer(b.testArg1,b.testArg2,a)},function(a,b){return-((b.delta_v-a.delta_v)/1)},{testArg1:c,testArg2:b});return new KEPLER.Transfer(c,b,a)};
KEPLER.TransferSolver.minDeltaV=function(c,b){for(var a=c.clone(),d=b.clone(),f=a.getElements(),d=d.getElements(),g=Math.min(f.T,d.T)/8,h=Math.ceil(Math.max(f.T,d.T)/g),e=0,m=g*h,f={},l=0;l<h;l++){var e=Math.ceil(l*g),m=Math.floor((l+1)*g),a=c.clone(),d=b.clone(),p=KEPLER.TransferSolver.bisectionSlopeSolver(e,m,function(a,b){var c=new KEPLER.TransferSolver.minDeltaV_LaunchSpecified(b.testArg1,b.testArg2,a);return{waitTime:a,transfer:c}},function(a,b,c,d){return-((b.transfer.delta_v-a.transfer.delta_v)/
1)},{testArg1:a,testArg2:d});f[p]=KEPLER.TransferSolver.minDeltaV_LaunchSpecified(a,d,p)}g={waitTime:p,transfer:f[p]};for(chunk in f)f[chunk].delta_v<=g.transfer.delta_v&&(g={waitTime:chunk,transfer:f[chunk]});return g};
KEPLER.TransferSolver.minTime_LaunchSpecified=function(c,b,a,d){d=void 0===d?0:d;c=c.clone();b=b.clone();c.addTime(d);b.addTime(d);d=c.getElements();var f=b.getElements(),f=KEPLER.TransferSolver.bisectionSlopeSolver(1,Math.max(d.T,f.T),function(a,b){return new KEPLER.Transfer(b.testArg1,b.testArg2,a)},function(b,c,d,f){c=c.delta_v;b=(c-b.delta_v)/1;if(isNaN(b))return 1;if(c<a)return-1;maxXValue=f();return maxXValue.delta_v<=a?1:-b},{testArg1:c,testArg2:b});d=new KEPLER.Transfer(c,b,f);c=new KEPLER.Transfer(c,
b,f+1);return d.delta_v<=c.delta_v?d:c};
KEPLER.TransferSolver.minTime=function(c,b,a){for(var d=c.clone(),f=b.clone(),d=d.getElements(),f=f.getElements(),g=Math.min(d.T,f.T)/8,h=Math.ceil(Math.max(d.T,f.T)/g),e=0,m=g*h,l={},p=0;p<h;p++)if(e=Math.ceil(p*g),m=Math.floor((p+1)*g),d=c.clone(),f=b.clone(),e=KEPLER.TransferSolver.bisectionSlopeSolver(e,m,function(a,b){var c=KEPLER.TransferSolver.minTime_LaunchSpecified(b.testArg1,b.testArg2,b.testArg3,a);return{waitTime:a,transfer:c}},function(b,c,d,e){var f=b.transfer.delta_v,g=(c.transfer.delta_v-
f)/1;b=(c.waitTime+c.transfer.duration-(b.waitTime+b.transfer.duration))/1;if(isNaN(g))return 1;if(f<a)return-b;minXValue=d();maxXValue=e();return minXValue.delta_v<=a?-1:maxXValue.delta_v<=a?1:-g},{testArg1:d,testArg2:f,testArg3:a}),l[e]=KEPLER.TransferSolver.minTime_LaunchSpecified(d,f,a,e),l[e].delta_v<=a)return{waitTime:e,transfer:l[e]};return-1};var EXAMPLE={};EXAMPLE.Sol=new KEPLER.AstroBody("Sol",KEPLER.SOL_MASS,new KEPLER.NULL_ORBIT);
EXAMPLE.Mercury=new KEPLER.AstroBody("Mercury",3.302E23,new KEPLER.Orbit(EXAMPLE.Sol,.3870982252717257*KEPLER.AU,.2056302512089075,172.7497133778637*KEPLER.DEGREE,7.005014199657344*KEPLER.DEGREE,29.12428058698772*KEPLER.DEGREE,48.33053756455964*KEPLER.DEGREE));
EXAMPLE.Venus=new KEPLER.AstroBody("Venus",4.8685E24,new KEPLER.Orbit(EXAMPLE.Sol,.7233268496749391*KEPLER.AU,.006755697267164094,49.31425178852966*KEPLER.DEGREE,3.394589632336535*KEPLER.DEGREE,55.185414554522*KEPLER.DEGREE,76.67837563371675*KEPLER.DEGREE));
EXAMPLE.Earth=new KEPLER.AstroBody("Earth",5.97219E24,new KEPLER.Orbit(EXAMPLE.Sol,1.000371833989169*KEPLER.AU,.01704239716781501,358.1891404220149*KEPLER.DEGREE,2.669113820737183E-4*KEPLER.DEGREE,297.7668064579176*KEPLER.DEGREE,163.9752443600624*KEPLER.DEGREE));
EXAMPLE.Luna=new KEPLER.AstroBody("Luna",7.349E22,new KEPLER.Orbit(EXAMPLE.Earth,381218.6882902056*KEPLER.KM,.06476694137484437,140.7402568949268*KEPLER.DEGREE,5.240010960708354*KEPLER.DEGREE,308.135902507981*KEPLER.DEGREE,123.9837037681769*KEPLER.DEGREE));EXAMPLE.Mars=new KEPLER.AstroBody("Mars",6.4185E23,new KEPLER.Orbit(EXAMPLE.Sol,1.523678184302188*KEPLER.AU,.09331460653723893,19.0945088699962*KEPLER.DEGREE,1.84987660922101*KEPLER.DEGREE,286.5373577554387*KEPLER.DEGREE,49.56199966373916*KEPLER.DEGREE));
EXAMPLE.Phobos=new KEPLER.AstroBody("Phobos",1.08E20,new KEPLER.Orbit(EXAMPLE.Mars,9378.286882214712*KEPLER.KM,.01541577713745092,345.810365877979*KEPLER.DEGREE,26.05134469392531*KEPLER.DEGREE,342.3765589430989*KEPLER.DEGREE,84.81060423679303*KEPLER.DEGREE));
EXAMPLE.Deimos=new KEPLER.AstroBody("Deimos",1.8E20,new KEPLER.Orbit(EXAMPLE.Mars,23458.88830758717*KEPLER.KM,2.419395670375644E-4,244.1640161731743*KEPLER.DEGREE,27.57017394063173*KEPLER.DEGREE,190.2368646630796*KEPLER.DEGREE,83.6637869299841*KEPLER.DEGREE));
EXAMPLE.voyager1=new KEPLER.Spacecraft("voyager1",722,10,3369,new KEPLER.Orbit(EXAMPLE.Sol,-3.220924861390099*KEPLER.AU,3.707585664603564,1248.081698810124*KEPLER.DEGREE,35.81757543323521*KEPLER.DEGREE,337.956332715058*KEPLER.DEGREE,179.2513338910511*KEPLER.DEGREE));
EXAMPLE.iss=new KEPLER.Spacecraft("ISS",370131,0,0,new KEPLER.Orbit(EXAMPLE.Earth,6759.645260772543*KEPLER.KM,.002048033237342145,329.2219482993897*KEPLER.DEGREE,52.17497644819966*KEPLER.DEGREE,86.11226361123934*KEPLER.DEGREE,259.2819760903027*KEPLER.DEGREE));EXAMPLE.TransferISSToMoon=new KEPLER.Transfer(EXAMPLE.iss.orbit,EXAMPLE.Luna.orbit,3*KEPLER.DAY);
